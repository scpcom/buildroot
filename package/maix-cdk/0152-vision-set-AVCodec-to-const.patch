From 015236d8eadb59fe86eb28e7e5f6dbdd22968f91 Mon Sep 17 00:00:00 2001
From: scpcom <scpcom@gmx.de>
Date: Fri, 28 Mar 2025 04:53:38 +0100
Subject: [PATCH 2/4] vision: set AVCodec to const

---
 .../vision/port/maixcam/maix_rtmp_maixcam.cpp    |  4 ++--
 .../vision/port/maixcam/maix_video_mmf.cpp       | 16 ++++++++--------
 2 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/components/vision/port/maixcam/maix_rtmp_maixcam.cpp b/components/vision/port/maixcam/maix_rtmp_maixcam.cpp
index 9a1155d..9b9c046 100644
--- a/components/vision/port/maixcam/maix_rtmp_maixcam.cpp
+++ b/components/vision/port/maixcam/maix_rtmp_maixcam.cpp
@@ -45,7 +45,7 @@ class RTMPClient
 
         bool has_audio = false;
         AVStream *audio_stream = nullptr;
-        AVCodec *audio_codec = nullptr;
+        const AVCodec *audio_codec = nullptr;
         AVFrame *audio_frame = nullptr;
         AVCodecContext *audio_codec_ctx = NULL;
         SwrContext *audio_swr_ctx = nullptr;
@@ -106,7 +106,7 @@ public:
                 goto _free_format_context;
             }
 
-            AVCodec *audio_codec = avcodec_find_encoder(AV_CODEC_ID_AAC);
+            const AVCodec *audio_codec = avcodec_find_encoder(AV_CODEC_ID_AAC);
             if (!audio_codec) {
 				log::info("Can't find audio encoder");
                 goto _free_format_context;
diff --git a/components/vision/port/maixcam/maix_video_mmf.cpp b/components/vision/port/maixcam/maix_video_mmf.cpp
index 4ab921d..89875c4 100644
--- a/components/vision/port/maixcam/maix_video_mmf.cpp
+++ b/components/vision/port/maixcam/maix_video_mmf.cpp
@@ -210,7 +210,7 @@ namespace maix::video
 
         AVStream *audio_stream = NULL;
         AVCodecContext *audio_codec_ctx = NULL;
-        AVCodec *audio_codec = NULL;
+        const AVCodec *audio_codec = NULL;
         AVFrame *audio_frame = NULL;
         SwrContext *swr_ctx = NULL;
         AVPacket *audio_packet = NULL;
@@ -363,7 +363,7 @@ namespace maix::video
             /* audio init */
             AVStream *audio_stream = NULL;
             AVCodecContext *audio_codec_ctx = NULL;
-            AVCodec *audio_codec = NULL;
+            const AVCodec *audio_codec = NULL;
             AVFrame *audio_frame = NULL;
             SwrContext *swr_ctx = NULL;
             AVPacket *audio_packet = NULL;
@@ -377,7 +377,7 @@ namespace maix::video
             int channels = 1;
             int bitrate = 128000;
             enum AVSampleFormat format = AV_SAMPLE_FMT_S16;
-            err::check_null_raise(audio_codec = avcodec_find_encoder(AV_CODEC_ID_AAC), "Could not find aac encoder");
+            err::check_null_raise((void*)(audio_codec = avcodec_find_encoder(AV_CODEC_ID_AAC)), "Could not find aac encoder");
             err::check_null_raise(audio_stream = avformat_new_stream(outputFormatContext, NULL), "Could not allocate stream");
             err::check_null_raise(audio_codec_ctx = avcodec_alloc_context3(audio_codec), "Could not allocate audio codec context");
             audio_codec_ctx->codec_id = AV_CODEC_ID_AAC;
@@ -1492,7 +1492,7 @@ _exit:
         PAYLOAD_TYPE_E vdec_type = PT_H264;
         video_format_e video_format = VIDEO_FORMAT_H264;
         err::check_null_raise(_param, "malloc failed!");
-        AVCodec *codec = NULL;
+        const AVCodec *codec = NULL;
         AVFormatContext *pFormatContext = avformat_alloc_context();
         err::check_null_raise(pFormatContext, "malloc failed!");
         err::check_bool_raise(!avformat_open_input(&pFormatContext, _path.c_str(), NULL, NULL), "Could not open file");
@@ -1589,7 +1589,7 @@ _exit:
         }
 
         /* audio process */
-        AVCodec *audio_codec = NULL;
+        const AVCodec *audio_codec = NULL;
         AVCodecContext *audio_codec_ctx = NULL;
         AVFrame *audio_frame = NULL;
         SwrContext *swr_ctx = NULL;
@@ -1601,7 +1601,7 @@ _exit:
         if (_has_audio) {
             AVCodecParameters *audio_codecpar = pFormatContext->streams[audio_stream_index]->codecpar;
             err::check_null_raise(audio_codecpar, "Could not find audio codec parameters");
-            err::check_null_raise(audio_codec = avcodec_find_decoder(audio_codecpar->codec_id), "Could not find audio codec");
+            err::check_null_raise((void*)(audio_codec = avcodec_find_decoder(audio_codecpar->codec_id)), "Could not find audio codec");
             err::check_null_raise(audio_codec_ctx = avcodec_alloc_context3(audio_codec), "Could not allocate audio codec context");
             err::check_bool_raise(avcodec_parameters_to_context(audio_codec_ctx, audio_codecpar) >= 0, "Could not copy audio codec parameters to decoder context");
             err::check_bool_raise(avcodec_open2(audio_codec_ctx, codec, NULL) >= 0, "Could not open audio codec");
@@ -3920,7 +3920,7 @@ _exit:
         /* audio init */
         AVStream *audio_stream = NULL;
         AVCodecContext *audio_codec_ctx = NULL;
-        AVCodec *audio_codec = NULL;
+        const AVCodec *audio_codec = NULL;
         AVFrame *audio_frame = NULL;
         SwrContext *swr_ctx = NULL;
         AVPacket *audio_packet = NULL;
@@ -3939,7 +3939,7 @@ _exit:
         audio_packet->data = NULL;
         audio_packet->size = 0;
 
-        err::check_null_raise(audio_codec = avcodec_find_encoder(AV_CODEC_ID_AAC), "Could not find aac encoder");
+        err::check_null_raise((void*)(audio_codec = avcodec_find_encoder(AV_CODEC_ID_AAC)), "Could not find aac encoder");
         err::check_null_raise(audio_stream = avformat_new_stream(outputFormatContext, NULL), "Could not allocate stream");
         err::check_null_raise(audio_codec_ctx = avcodec_alloc_context3(audio_codec), "Could not allocate audio codec context");
         audio_codec_ctx->codec_id = AV_CODEC_ID_AAC;
-- 
2.34.1

