From 4ba8983bf9046059a6305590397af88ce03ac016 Mon Sep 17 00:00:00 2001
From: scpcom <scpcom@gmx.de>
Date: Wed, 9 Oct 2024 18:42:46 +0200
Subject: [PATCH] server: lib: add flag to force download

---
 server/service/application/lib.go     | 21 ++++++++++++++++++++-
 server/service/application/service.go |  1 +
 2 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/server/service/application/lib.go b/server/service/application/lib.go
index fb93bd1..a2868a4 100644
--- a/server/service/application/lib.go
+++ b/server/service/application/lib.go
@@ -16,6 +16,7 @@ import (
 func (s *Service) GetLib(c *gin.Context) {
 	var rsp proto.Response
 
+	force, _ := forceDownloadLib()
 	exist, err := isLibExist()
 	if err != nil {
 		rsp.ErrRsp(c, -1, "check lib error")
@@ -23,7 +24,7 @@ func (s *Service) GetLib(c *gin.Context) {
 	}
 
 	data := &proto.GetLibRsp{
-		Exist: exist,
+		Exist: exist && !force,
 	}
 
 	rsp.OkRspWithData(c, data)
@@ -33,8 +33,9 @@ func (s *Service) GetLib(c *gin.Context) {
 func (s *Service) UpdateLib(c *gin.Context) {
 	var rsp proto.Response
 
+	force, _ := forceDownloadLib()
 	exist, _ := isLibExist()
-	if exist {
+	if exist  && !force {
 		rsp.OkRsp(c)
 		return
 	}
@@ -56,12 +57,30 @@ func (s *Service) UpdateLib(c *gin.Context) {
 		return
 	}
 
+	if force {
+		_ = os.Remove(LibForceDl)
+	}
+
 	rsp.OkRsp(c)
 	log.Debugf("update lib success")
 
 	_ = exec.Command("sh", "-c", "/etc/init.d/S95nanokvm restart").Run()
 }
 
+func forceDownloadLib() (bool, error) {
+	_, err := os.Stat(LibForceDl)
+
+	if err == nil {
+		return true, nil
+	}
+
+	if errors.Is(err, os.ErrNotExist) {
+		return false, nil
+	}
+
+	return false, err
+}
+
 func isLibExist() (bool, error) {
 	libPath := fmt.Sprintf("%s/%s", LibDir, LibName)
 	_, err := os.Stat(libPath)
diff --git a/server/service/application/service.go b/server/service/application/service.go
index dea03c0..1686df0 100644
--- a/server/service/application/service.go
+++ b/server/service/application/service.go
@@ -10,6 +10,7 @@ const (
 	Backup      = "/root/old"
 	LibDir      = "/kvmapp/kvm_system/dl_lib"
 	LibName     = "libmaixcam_lib.so"
+	LibForceDl  = "/kvmapp/force_dl_lib"
 	VersionFile = "/kvmapp/version"
 )
 
-- 
2.34.1

