From 30bc34b466c6f73aa0b6ca091ea500a4af676871 Mon Sep 17 00:00:00 2001
From: scpcom <scpcom@gmx.de>
Date: Thu, 20 Feb 2025 17:41:09 +0100
Subject: [PATCH] vison: kvm: cleanup venc on type change

---
 vision/components/kvm/src/kvm_vision.cpp | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/vision/components/kvm/src/kvm_vision.cpp b/vision/components/kvm/src/kvm_vision.cpp
index 5d8f652..0afd8f8 100644
--- a/vision/components/kvm/src/kvm_vision.cpp
+++ b/vision/components/kvm/src/kvm_vision.cpp
@@ -1432,6 +1432,13 @@ int kvmv_read_img(uint16_t _width, uint16_t _height, uint8_t _type, uint16_t _ql
 
         // img exist
         // Encode
+        if(kvmv_cfg.venc_type == VENC_MJPEG && kvmv_cfg.venc_type != _type){
+            mmf_enc_jpg_deinit(0);
+        }
+        if(kvmv_cfg.venc_type == VENC_H264 && kvmv_cfg.venc_type != _type){
+            mmf_del_venc_channel(kvm_venc.mmf_venc_chn);
+            kvm_venc.enc_h264_init = 0;
+        }
         if(_type == VENC_H264 && kvmv_cfg.venc_type != _type){
             kvm_venc.enc_h264_init = 1;
             // debug("[kvmv] change to h264\n");
-- 
2.34.1

