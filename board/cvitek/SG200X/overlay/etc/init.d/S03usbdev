#!/bin/sh

if [ "$1" = "start" ]
then
	. /etc/profile
	if [ -e /boot/usb.host ]
	then
		echo "usb mode: host"
		echo host > /proc/cviusb/otg_role
	elif [ -e /boot/usb.dev ]
	then
		echo "usb mode: device"
		cd /sys/kernel/config/usb_gadget
		mkdir -p g0
		cd g0
		if [ -e /boot/usb.idVendor ]
		then
			cat /boot/usb.idVendor > idVendor
		else
			echo 0x3346 > idVendor
		fi
		if [ -e /boot/usb.idProduct ]
		then
			cat /boot/usb.idProduct > idProduct
		else
			echo 0x1009 > idProduct
		fi
		mkdir -p strings/0x409
		if [ -e /boot/usb.serialnumber ]
		then
			cat /boot/usb.serialnumber > strings/0x409/serialnumber
		else
			echo '0123456789ABCDEF' > strings/0x409/serialnumber
		fi
		if [ -e /boot/usb.manufacturer ]
		then
			cat /boot/usb.manufacturer > strings/0x409/manufacturer
		else
			echo 'sipeed' > strings/0x409/manufacturer
		fi
		if [ -e /boot/usb.product ]
		then
			cat /boot/usb.product > strings/0x409/product
		else
			echo 'licheervnano' > strings/0x409/product
		fi
		mkdir -p configs/c.1
		if [ -e /boot/usb.GS0 ]
		then
			mkdir -p functions/acm.GS0
			if [ ! -e functions/acm.GS0 ]
			then
				ln -s functions/acm.GS0 configs/c.1/
			fi
		fi
		if [ -e /boot/usb.rndis0 ]
		then
			mkdir -p functions/rndis.usb0
			if [ ! -e functions/rndis.usb0 ]
			then
				ln -s functions/rndis.usb0 configs/c.1/
			fi
		fi
		if [ -e /boot/usb.disk0 ]
		then
			mkdir -p functions/mass_storage.disk0
			if [ ! -e functions/rndis.usb0 ]
			then
				ln -s functions/mass_storage.disk0 configs/c.1/
			fi
			echo 1 > functions/mass_storage.disk0/lun.0/removable
			if [ -e /boot/usb.disk0.ro ]
			then
				echo 1 > functions/mass_storage.disk0/lun.0/ro
				echo 1 > functions/mass_storage.disk0/lun.0/cdrom
			fi
			disk=$(cat /boot/usb.disk0)
			if [ -z "${disk}" ]
			then
				if [ ! -e /mnt/usbdisk.img ]
				then
					dd if=/dev/zero of=/mnt/usbdisk.img bs=1M count=16
					mkfs.vfat /mnt/usbdisk.img
				fi
				echo /mnt/usbdisk.img > functions/mass_storage.disk0/lun.0/file
			else
				cat /boot/usb.disk0 > functions/mass_storage.disk0/lun.0/file
			fi
		fi
		ls /sys/class/udc/ | cat > UDC
		echo device > /proc/cviusb/otg_role
	fi
fi

if [ "$1" = "stop" ]
then
	echo '' > /sys/kernel/config/usb_gadget/g0/UDC
	echo host > /proc/cviusb/otg_role
fi
