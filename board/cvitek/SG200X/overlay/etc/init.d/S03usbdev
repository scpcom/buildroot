#!/bin/sh

if [ "$1" = "start" ]
then
	. /etc/profile
	if [ -e /boot/usb.host ]
	then
		echo "usb mode: host"
		echo host > /proc/cviusb/otg_role
	elif [ -e /boot/usb.dev ]
	then
		echo "usb mode: device"
		cd /sys/kernel/config/usb_gadget
		mkdir g0
		cd g0
		if [ -e /boot/usb.idVendor ]
		then
			cat /boot/usb.idVendor > idVendor
		else
			echo 0123 > idVendor
		fi
		if [ -e /boot/usb.idProduct ]
		then
			cat /boot/usb.idProduct > idProduct
		else
			echo 4567 > idProduct
		fi
		mkdir strings/0x409
		if [ -e /boot/usb.serialnumber ]
		then
			cat /boot/usb.serialnumber > strings/0x409/serialnumber
		else
			echo '0123456789ABCDEF' > strings/0x409/serialnumber
		fi
		if [ -e /boot/usb.manufacturer ]
		then
			cat /boot/usb.manufacturer > strings/0x409/manufacturer
		else
			echo 'sipeed' > strings/0x409/manufacturer
		fi
		if [ -e /boot/usb.product ]
		then
			cat /boot/usb.product > strings/0x409/product
		else
			echo 'licheervnano' > strings/0x409/product
		fi
		mkdir configs/c.1
		if [ -e /boot/usb.GS0 ]
		then
			mkdir functions/acm.GS0
			ln -s functions/acm.GS0 configs/c.1/
		fi
		if [ -e /boot/usb.rndis0 ]
		then
			mkdir functions/rndis.usb0
			ln -s functions/rndis.usb0 configs/c.1/
		fi
		ls /sys/class/udc/ | cat > UDC
		echo device > /proc/cviusb/otg_role
	fi
fi

if [ "$1" = "stop" ]
then
	echo '' > /sys/kernel/config/usb_gadget/g0/UDC
	echo host > /proc/cviusb/otg_role
fi
